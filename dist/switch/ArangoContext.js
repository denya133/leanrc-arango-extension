// Generated by CoffeeScript 2.5.1
(function() {
  // This file is part of leanrc-arango-extension.

  // leanrc-arango-extension is free software: you can redistribute it and/or modify
  // it under the terms of the GNU Lesser General Public License as published by
  // the Free Software Foundation, either version 3 of the License, or
  // (at your option) any later version.

  // leanrc-arango-extension is distributed in the hope that it will be useful,
  // but WITHOUT ANY WARRANTY; without even the implied warranty of
  // MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  // GNU Lesser General Public License for more details.

  // You should have received a copy of the GNU Lesser General Public License
  // along with leanrc-arango-extension.  If not, see <https://www.gnu.org/licenses/>.
  var Stream, assert, createError;

  assert = require('assert');

  createError = require('http-errors');

  Stream = require('stream');

  module.exports = function(Module) {
    var AnyT, ArangoContext, ArangoRequest, ArangoResponse, ContextInterface, Cookies, CookiesInterface, CoreObject, DEVELOPMENT, FuncG, MaybeG, NilT, RequestInterface, ResponseInterface, SwitchInterface, UnionG, _, statuses;
    ({
      DEVELOPMENT,
      AnyT,
      NilT,
      FuncG,
      UnionG,
      MaybeG,
      RequestInterface,
      ResponseInterface,
      SwitchInterface,
      CookiesInterface,
      ContextInterface,
      CoreObject,
      // ContextInterface
      // RequestInterface
      // ResponseInterface
      // SwitchInterface
      // CookiesInterface
      ArangoRequest,
      ArangoResponse,
      Cookies,
      Utils: {_, statuses}
    } = Module.prototype);
    return ArangoContext = (function() {
      class ArangoContext extends CoreObject {};

      ArangoContext.inheritProtected();

      ArangoContext.implements(ContextInterface);

      ArangoContext.module(Module);

      ArangoContext.public({
        req: Object // native request object
      });

      ArangoContext.public({
        res: Object // native response object
      });

      ArangoContext.public({
        request: MaybeG(RequestInterface)
      });

      ArangoContext.public({
        response: MaybeG(ResponseInterface)
      });

      ArangoContext.public({
        cookies: MaybeG(CookiesInterface)
      });

      ArangoContext.public({
        accept: Object
      });

      ArangoContext.public({
        state: MaybeG(Object)
      });

      ArangoContext.public({
        switch: SwitchInterface
      });

      ArangoContext.public({
        respond: MaybeG(Boolean)
      });

      ArangoContext.public({
        routePath: MaybeG(String)
      });

      ArangoContext.public({
        pathParams: MaybeG(Object)
      });

      ArangoContext.public({
        transaction: MaybeG(Object)
      });

      ArangoContext.public({
        session: MaybeG(Object)
      });

      ArangoContext.public({
        isPerformExecution: Boolean
      }, {
        default: false
      });

      // @public database: String # возможно это тоже надо получать из метода из отдельного модуля
      ArangoContext.public({
        throw: FuncG([UnionG(String, Number), MaybeG(String), MaybeG(Object)])
      }, {
        default: function(...args) {
          throw createError(...args);
        }
      });

      ArangoContext.public({
        assert: FuncG([AnyT, MaybeG(UnionG(String, Number)), MaybeG(String), MaybeG(Object)])
      }, {
        default: assert
      });

      ArangoContext.public({
        onerror: FuncG([MaybeG(AnyT)])
      }, {
        default: function(err) {
          var code, headerSent, message, msg, ref, ref1, ref2, ref3, vlHeaderNames;
          if (err == null) {
            return;
          }
          if (!_.isError(err)) {
            err = new Error(`non-error thrown: ${err}`);
          }
          headerSent = false;
          if (this.headerSent || !this.writable) {
            headerSent = err.headerSent = true;
          }
          this.switch.getViewComponent().emit('error', err, this);
          if (headerSent) {
            return;
          }
          if (_.isFunction(this.res.getHeaderNames)) {
            this.res.getHeaderNames().forEach((name) => {
              return this.res.removeHeader(name);
            });
          }
          if ((vlHeaderNames = Object.keys((ref = this.res.headers) != null ? ref : {})).length > 0) {
            vlHeaderNames.forEach((name) => {
              return this.res.removeHeader(name);
            });
          }
          this.response.set((ref1 = err.headers) != null ? ref1 : {});
          this.response.type = 'text';
          if ('ENOENT' === err.code) {
            err.status = 404;
          }
          if (!_.isNumber(err.status) || !statuses[err.status]) {
            err.status = 500;
          }
          code = statuses[err.status];
          msg = err.expose ? err.message : code;
          message = {
            error: true,
            errorNum: err.status,
            errorMessage: msg,
            code: (ref2 = err.code) != null ? ref2 : code
          };
          if (this.switch.configs.environment === DEVELOPMENT) {
            message.exception = `${(ref3 = err.name) != null ? ref3 : 'Error'}: ${msg}`;
            message.stacktrace = err.stack.split('\n');
          }
          this.res.status(err.status);
          this.res.send(message);
        }
      });

      // Request aliases
      ArangoContext.public({
        header: Object
      }, {
        get: function() {
          return this.request.header;
        }
      });

      ArangoContext.public({
        headers: Object
      }, {
        get: function() {
          return this.request.headers;
        }
      });

      ArangoContext.public({
        method: String
      }, {
        get: function() {
          return this.request.method;
        },
        set: function(method) {
          return this.request.method = method;
        }
      });

      ArangoContext.public({
        url: String
      }, {
        get: function() {
          return this.request.url;
        },
        set: function(url) {
          return this.request.url = url;
        }
      });

      ArangoContext.public({
        originalUrl: String
      });

      ArangoContext.public({
        origin: String
      }, {
        get: function() {
          return this.request.origin;
        }
      });

      ArangoContext.public({
        href: String
      }, {
        get: function() {
          return this.request.href;
        }
      });

      ArangoContext.public({
        path: String
      }, {
        get: function() {
          return this.request.path;
        },
        set: function(path) {
          return this.request.path = path;
        }
      });

      ArangoContext.public({
        query: Object
      }, {
        get: function() {
          return this.request.query;
        },
        set: function(query) {
          return this.request.query = query;
        }
      });

      ArangoContext.public({
        querystring: String
      }, {
        get: function() {
          return this.request.querystring;
        },
        set: function(querystring) {
          return this.request.querystring = querystring;
        }
      });

      ArangoContext.public({
        host: String
      }, {
        get: function() {
          return this.request.host;
        }
      });

      ArangoContext.public({
        hostname: String
      }, {
        get: function() {
          return this.request.hostname;
        }
      });

      ArangoContext.public({
        fresh: Boolean
      }, {
        get: function() {
          return this.request.fresh;
        }
      });

      ArangoContext.public({
        stale: Boolean
      }, {
        get: function() {
          return this.request.stale;
        }
      });

      ArangoContext.public({
        socket: MaybeG(Object)
      }, {
        get: function() {
          return this.request.socket;
        }
      });

      ArangoContext.public({
        protocol: String
      }, {
        get: function() {
          return this.request.protocol;
        }
      });

      ArangoContext.public({
        secure: Boolean
      }, {
        get: function() {
          return this.request.secure;
        }
      });

      ArangoContext.public({
        ip: String
      }, {
        get: function() {
          return this.request.ip;
        }
      });

      ArangoContext.public({
        ips: Array
      }, {
        get: function() {
          return this.request.ips;
        }
      });

      ArangoContext.public({
        subdomains: Array
      }, {
        get: function() {
          return this.request.subdomains;
        }
      });

      ArangoContext.public({
        'is': FuncG([UnionG(String, Array)], UnionG(String, Boolean, NilT))
      }, {
        default: function(...args) {
          return this.request.is(...args);
        }
      });

      ArangoContext.public({
        accepts: FuncG([MaybeG(UnionG(String, Array))], UnionG(String, Array, Boolean))
      }, {
        default: function(...args) {
          return this.request.accepts(...args);
        }
      });

      ArangoContext.public({
        acceptsEncodings: FuncG([MaybeG(UnionG(String, Array))], UnionG(String, Array))
      }, {
        default: function(...args) {
          return this.request.acceptsEncodings(...args);
        }
      });

      ArangoContext.public({
        acceptsCharsets: FuncG([MaybeG(UnionG(String, Array))], UnionG(String, Array))
      }, {
        default: function(...args) {
          return this.request.acceptsCharsets(...args);
        }
      });

      ArangoContext.public({
        acceptsLanguages: FuncG([MaybeG(UnionG(String, Array))], UnionG(String, Array))
      }, {
        default: function(...args) {
          return this.request.acceptsLanguages(...args);
        }
      });

      ArangoContext.public({
        get: FuncG(String, String)
      }, {
        default: function(...args) {
          return this.request.get(...args);
        }
      });

      // Response aliases
      ArangoContext.public({
        body: MaybeG(UnionG(String, Buffer, Object, Array, Number, Boolean, Stream))
      }, {
        get: function() {
          return this.response.body;
        },
        set: function(body) {
          return this.response.body = body;
        }
      });

      ArangoContext.public({
        status: MaybeG(Number)
      }, {
        get: function() {
          return this.response.status;
        },
        set: function(status) {
          return this.response.status = status;
        }
      });

      ArangoContext.public({
        message: String
      }, {
        get: function() {
          return this.response.message;
        },
        set: function(message) {
          return this.response.message = message;
        }
      });

      ArangoContext.public({
        length: Number
      }, {
        get: function() {
          return this.response.length;
        },
        set: function(length) {
          return this.response.length = length;
        }
      });

      ArangoContext.public({
        writable: Boolean
      }, {
        get: function() {
          return this.response.writable;
        }
      });

      ArangoContext.public({
        type: MaybeG(String)
      }, {
        get: function() {
          return this.response.type;
        },
        set: function(type) {
          return this.response.type = type;
        }
      });

      ArangoContext.public({
        headerSent: MaybeG(Boolean)
      }, {
        get: function() {
          return this.response.headerSent;
        }
      });

      ArangoContext.public({
        redirect: FuncG([String, MaybeG(String)])
      }, {
        default: function(...args) {
          return this.response.redirect(...args);
        }
      });

      ArangoContext.public({
        attachment: FuncG(String)
      }, {
        default: function(...args) {
          return this.response.attachment(...args);
        }
      });

      ArangoContext.public({
        set: FuncG([UnionG(String, Object), MaybeG(AnyT)])
      }, {
        default: function(...args) {
          return this.response.set(...args);
        }
      });

      ArangoContext.public({
        append: FuncG([String, UnionG(String, Array)])
      }, {
        default: function(...args) {
          return this.response.append(...args);
        }
      });

      ArangoContext.public({
        vary: FuncG(String)
      }, {
        default: function(...args) {
          return this.response.vary(...args);
        }
      });

      ArangoContext.public({
        flushHeaders: Function
      }, {
        default: function(...args) {
          return this.response.flushHeaders(...args);
        }
      });

      ArangoContext.public({
        remove: FuncG(String)
      }, {
        default: function(...args) {
          return this.response.remove(...args);
        }
      });

      ArangoContext.public({
        lastModified: MaybeG(Date)
      }, {
        set: function(date) {
          return this.response.lastModified = date;
        }
      });

      ArangoContext.public({
        etag: String
      }, {
        set: function(etag) {
          return this.response.etag = etag;
        }
      });

      ArangoContext.public(ArangoContext.static(ArangoContext.async({
        restoreObject: Function
      }, {
        default: function*() {
          throw new Error(`restoreObject method not supported for ${this.name}`);
        }
      })));

      ArangoContext.public(ArangoContext.static(ArangoContext.async({
        replicateObject: Function
      }, {
        default: function*() {
          throw new Error(`replicateObject method not supported for ${this.name}`);
        }
      })));

      ArangoContext.public({
        init: FuncG([Object, Object, SwitchInterface])
      }, {
        default: function(req, res, switchInstanse) {
          var key, secure;
          this.super();
          this.req = req;
          this.res = res;
          this.switch = switchInstanse;
          this.originalUrl = req.url;
          this.accept = {
            types: function(...args) {
              return req.accepts(...args);
            },
            charsets: function(...args) {
              return req.acceptsCharsets(...args);
            },
            encodings: function(...args) {
              return req.acceptsEncodings(...args);
            },
            languages: function(...args) {
              return req.acceptsLanguages(...args);
            }
          };
          this.request = ArangoRequest.new(this);
          this.response = ArangoResponse.new(this);
          key = this.switch.configs.cookieKey;
          secure = req.secure;
          this.cookies = Cookies.new(req, res, {key, secure});
          this.state = {};
        }
      });

      ArangoContext.initialize();

      return ArangoContext;

    }).call(this);
  };

}).call(this);
