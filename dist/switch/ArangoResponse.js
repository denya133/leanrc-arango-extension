// Generated by CoffeeScript 2.5.1
(function() {
  // This file is part of leanrc-arango-extension.

  // leanrc-arango-extension is free software: you can redistribute it and/or modify
  // it under the terms of the GNU Lesser General Public License as published by
  // the Free Software Foundation, either version 3 of the License, or
  // (at your option) any later version.

  // leanrc-arango-extension is distributed in the hope that it will be useful,
  // but WITHOUT ANY WARRANTY; without even the implied warranty of
  // MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  // GNU Lesser General Public License for more details.

  // You should have received a copy of the GNU Lesser General Public License
  // along with leanrc-arango-extension.  If not, see <https://www.gnu.org/licenses/>.
  var Stream, assert, getType, typeis,
    hasProp = {}.hasOwnProperty;

  typeis = require('type-is').is;

  assert = require('assert');

  getType = require('mime-types').contentType;

  Stream = require('stream');

  module.exports = function(Module) {
    var AnyT, ArangoResponse, ContextInterface, CoreObject, FuncG, MaybeG, NilT, ResponseInterface, SwitchInterface, UnionG, _, statuses;
    ({
      AnyT,
      NilT,
      FuncG,
      UnionG,
      MaybeG,
      ResponseInterface,
      SwitchInterface,
      ContextInterface,
      CoreObject,
      // ResponseInterface
      // SwitchInterface
      // ContextInterface
      Utils: {_, statuses}
    } = Module.prototype);
    return ArangoResponse = (function() {
      class ArangoResponse extends CoreObject {};

      ArangoResponse.inheritProtected();

      ArangoResponse.implements(ResponseInterface);

      ArangoResponse.module(Module);

      ArangoResponse.public({
        res: Object // native response object
      }, {
        get: function() {
          return this.ctx.res;
        }
      });

      ArangoResponse.public({
        switch: SwitchInterface
      }, {
        get: function() {
          return this.ctx.switch;
        }
      });

      ArangoResponse.public({
        ctx: ContextInterface
      });

      ArangoResponse.public({
        socket: MaybeG(Object)
      }, {
        get: function() {}
      });

      ArangoResponse.public({
        header: Object
      }, {
        get: function() {
          return this.headers;
        }
      });

      ArangoResponse.public({
        headers: Object
      }, {
        get: function() {
          return this.res.headers;
        }
      });

      ArangoResponse.public({
        status: MaybeG(Number)
      }, {
        get: function() {
          return this.res.statusCode;
        },
        set: function(code) {
          assert(_.isNumber(code), 'status code must be a number');
          assert(statuses[code], `invalid status code: ${code}`);
          this._explicitStatus = true;
          this.res.statusCode = code;
          this.res.statusMessage = statuses[code];
          if (Boolean(this.body && statuses.empty[code])) {
            this.body = null;
          }
          return code;
        }
      });

      ArangoResponse.public({
        message: String
      }, {
        get: function() {
          var ref;
          return (ref = this.res.statusMessage) != null ? ref : statuses[this.status];
        },
        set: function(msg) {
          this.res.statusMessage = msg;
          return msg;
        }
      });

      ArangoResponse.public({
        body: MaybeG(UnionG(String, Buffer, Object, Array, Number, Boolean, Stream))
      }, {
        get: function() {
          return this._body;
        },
        set: function(val) {
          var original, setType;
          original = this._body;
          this._body = val;
          if (val == null) {
            if (!statuses.empty[this.status]) {
              this.status = 204;
            }
            this.remove('Content-Type');
            this.remove('Content-Length');
            this.remove('Transfer-Encoding');
            return;
          }
          if (!this._explicitStatus) {
            this.status = 200;
          }
          setType = !this.headers['content-type'];
          if (_.isString(val)) {
            if (setType) {
              this.type = /^\s*</.test(val) ? 'html' : 'text';
            }
            return;
          }
          if (_.isBuffer(val)) {
            if (setType) {
              this.type = 'bin';
            }
            return;
          }
          this.remove('Content-Length');
          this.type = 'json';
        }
      });

      ArangoResponse.public({
        length: Number
      }, {
        get: function() {
          var len;
          len = this.headers['content-length'];
          if (len == null) {
            if (!this.body) {
              return 0;
            }
            if (_.isString(this.body)) {
              return Buffer.byteLength(this.body);
            }
            if (_.isBuffer(this.body)) {
              return this.body.length;
            }
            if (_.isObjectLike(this.body)) {
              return Buffer.byteLength(JSON.stringify(this.body));
            }
            return 0;
          }
          return ~~Number(len);
        },
        set: function(n) {
          this.set('Content-Length', n);
          return n;
        }
      });

      ArangoResponse.public({
        headerSent: MaybeG(Boolean)
      }, {
        get: function() {
          return false;
        }
      });

      ArangoResponse.public({
        vary: FuncG(String)
      }, {
        default: function(...args) {
          this.res.vary(...args);
        }
      });

      ArangoResponse.public({
        redirect: FuncG([String, MaybeG(String)])
      }, {
        default: function(url, alt) {
          if ('back' === url) {
            url = this.ctx.get('Referrer') || alt || '/';
          }
          if (statuses.redirect[this.status]) {
            this.res.redirect(url);
          } else {
            this.res.redirect(302, url);
          }
        }
      });

      ArangoResponse.public({
        attachment: FuncG(String)
      }, {
        default: function(filename) {
          this.res.attachment(filename);
        }
      });

      ArangoResponse.public({
        lastModified: MaybeG(Date)
      }, {
        get: function() {
          var date;
          date = this.get('last-modified');
          if (date) {
            return new Date(date);
          }
        },
        set: function(val) {
          if (_.isString(val)) {
            val = new Date(val);
          }
          this.set('Last-Modified', val.toUTCString());
          return val;
        }
      });

      ArangoResponse.public({
        etag: String
      }, {
        get: function() {
          return this.get('ETag');
        },
        set: function(val) {
          if (!/^(W\/)?"/.test(val)) {
            val = `\"${val}\"`;
          }
          this.set('ETag', val);
          return val;
        }
      });

      // @public type: String,
      //   get: ->
      //     @res.type()
      //   set: (type)->
      //     @res.type type
      ArangoResponse.public({
        type: MaybeG(String)
      }, {
        get: function() {
          var type;
          type = this.get('Content-Type');
          if (!type) {
            return '';
          }
          return type.split(';')[0];
        },
        set: function(_type) {
          var type;
          type = getType(_type);
          if (type) {
            this.set('Content-Type', type);
          } else {
            this.remove('Content-Type');
          }
          return _type;
        }
      });

      ArangoResponse.public({
        'is': FuncG([UnionG(String, Array)], UnionG(String, Boolean, NilT))
      }, {
        default: function(...args) {
          var types;
          [types] = args;
          if (!types) {
            return this.type || false;
          }
          if (!_.isArray(types)) {
            types = args;
          }
          return typeis(this.type, types);
        }
      });

      ArangoResponse.public({
        get: FuncG(String, UnionG(String, Array))
      }, {
        default: function(field) {
          var ref;
          return (ref = this.headers[field.toLowerCase()]) != null ? ref : '';
        }
      });

      ArangoResponse.public({
        set: FuncG([UnionG(String, Object), MaybeG(AnyT)])
      }, {
        default: function(...args) {
          var field, key, val, value;
          [field, val] = args;
          if (2 === args.length) {
            if (_.isArray(val)) {
              val = val.map(String);
            } else {
              val = String(val);
            }
            this.res.setHeader(field, val);
          } else {
            for (key in field) {
              if (!hasProp.call(field, key)) continue;
              value = field[key];
              this.set(key, value);
            }
          }
        }
      });

      ArangoResponse.public({
        append: FuncG([String, UnionG(String, Array)])
      }, {
        default: function(field, val) {
          var prev;
          prev = this.get(field);
          if (prev) {
            if (_.isArray(prev)) {
              val = prev.concat(val);
            } else {
              val = [prev].concat(val);
            }
          }
          return this.set(field, val);
        }
      });

      ArangoResponse.public({
        remove: FuncG(String)
      }, {
        default: function(field) {
          this.res.removeHeader(field);
        }
      });

      ArangoResponse.public({
        flushHeaders: Function
      }, {
        default: function(field) {
          Object.keys(this.res.headers).forEach((name) => {
            return this.res.removeHeader(name);
          });
        }
      });

      ArangoResponse.public({
        writable: Boolean
      }, {
        get: function() {
          return true;
        }
      });

      ArangoResponse.public(ArangoResponse.static(ArangoResponse.async({
        restoreObject: Function
      }, {
        default: function*() {
          throw new Error(`restoreObject method not supported for ${this.name}`);
        }
      })));

      ArangoResponse.public(ArangoResponse.static(ArangoResponse.async({
        replicateObject: Function
      }, {
        default: function*() {
          throw new Error(`replicateObject method not supported for ${this.name}`);
        }
      })));

      ArangoResponse.public({
        init: FuncG(ContextInterface)
      }, {
        default: function(context) {
          this.super();
          this.ctx = context;
        }
      });

      ArangoResponse.initialize();

      return ArangoResponse;

    }).call(this);
  };

}).call(this);
